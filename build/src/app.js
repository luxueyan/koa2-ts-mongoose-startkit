"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Koa = require("koa");
const views = require("koa-views");
const json = require("koa-json");
const onerror = require("koa-onerror");
const bodyparser = require("koa-bodyparser");
const logger = require("koa-logger");
const staticServer = require("koa-static");
const Log4js = require("koa-log4");
const mongoose = require("mongoose");
const index_1 = require("./routes/index");
const users_1 = require("./routes/users");
const env_config_1 = require("../config/env.config");
const log4js_1 = require("../log4js");
Log4js.configure(log4js_1.default);
const logger4 = Log4js.getLogger('console');
logger4.info('---------Wellcome to kaitong pano----------');
logger4.info('                        _ooOoo_');
logger4.info('                       o8888888o');
logger4.info('                       88" . "88');
logger4.info('                       (| -_- |)');
logger4.info('                       O\  =  /O');
logger4.info('                    ____/`---\'\____');
logger4.info('                  .\'  \\|     |  `.');
logger4.info('                 /  \\|||  :  |||  \\');
logger4.info('                /  _||||| -:- |||||-  \\');
logger4.info('                |   | \\\  -  / |   |');
logger4.info('                | \_|  \'\'\---/\'\'  |   |');
logger4.info('                \  .-\__  `-`  ___/-. /');
logger4.info('              ___`. .\'  /--.--\  `. . __');
logger4.info('           ."" \'<  `.___\_<|>_/___.\'  >\'"".');
logger4.info('          | | :  `- \`.;`\ _ /`;.`/ - ` : | |');
logger4.info('          \  \ `-.   \_ __\ /__ _/   .-` /  /');
logger4.info('     ======`-.____`-.___\_____/___.-`____.-\'======');
logger4.info('                        `=---=\'');
logger4.info('    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^');
logger4.info('                  佛祖保佑       永无BUG');
const app = new Koa();
onerror(app);
mongoose.Promise = global.Promise;
const db = mongoose.createConnection(env_config_1.default.mongo.uri, env_config_1.default.mongo.options);
db.on('error', err => {
    const logger = Log4js.getLogger('error');
    logger.error('连接出错了：' + err);
});
db.on('open', () => logger4.info('成功连接数据库：' + env_config_1.default.mongo.uri));
app.use(bodyparser());
app.use(json());
app.use(logger());
app.use(staticServer(__dirname + '/public'));
app.use(views(__dirname + '/views', {
    extension: 'jade'
}));
app.use(Log4js.koaLogger(Log4js.getLogger('http'), { level: 'auto' }));
app.use(async (ctx, next) => {
    const start = +new Date();
    await next();
    const ms = +new Date() - start;
    logger4.info(`${ctx.method} ${ctx.url} - ${ms}ms`);
});
app.use(index_1.default.routes(), index_1.default.allowedMethods());
app.use(users_1.default.routes(), users_1.default.allowedMethods());
exports.default = app;
//# sourceMappingURL=app.js.map